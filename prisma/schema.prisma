datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  role      String   @default("BUYER") // "BUYER", "FACTORY", "ADMIN"
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  isBanned  Boolean  @default(false)
  
  // Relations
  factoryProfile FactoryProfile?
  buyerProfile   BuyerProfile?
  
  initiatedConversations Conversation[] @relation("Starter")
  receivedConversations  Conversation[] @relation("Receiver")
  messages               Message[]
  notifications          Notification[]
  filedDisputes          Dispute[]
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  type      String   // QUOTE_RECEIVED, ORDER_RECEIVED, ORDER_UPDATED, NEW_MESSAGE
  title     String
  message   String
  link      String?
  read      Boolean  @default(false)
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id])
}

model Conversation {
  id            String   @id @default(cuid())
  starterId     String
  receiverId    String
  lastMessageAt DateTime @default(now())
  subject       String?
  
  starter   User @relation("Starter", fields: [starterId], references: [id])
  receiver  User @relation("Receiver", fields: [receiverId], references: [id])
  
  messages  Message[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([starterId, receiverId])
}

model Message {
  id             String   @id @default(cuid())
  conversationId String
  senderId       String
  content        String
  attachmentUrl  String?
  attachmentType String? // IMAGE, DOCUMENT
  read           Boolean  @default(false)
  
  conversation Conversation @relation(fields: [conversationId], references: [id])
  sender       User         @relation(fields: [senderId], references: [id])
  
  createdAt DateTime @default(now())
}

model FactoryProfile {
  id             String  @id @default(cuid())
  businessName   String
  businessNameAr String?
  crNumber       String? // Commercial Registration
  licenseNumber  String?
  city           String?
  industry       String?
  description    String?
  crDocumentUrl  String? // URL to uploaded CR document
  licenseDocumentUrl String? // URL to uploaded Industrial License
  taxNumber      String? // VAT/Tax Number
  taxDocumentUrl String? // VAT/Tax Certificate
  sasoDocumentUrl String? // SASO/SABER Certificate (Optional)
  isVerified     Boolean @default(false)
  verificationStatus String @default("UNVERIFIED") // UNVERIFIED, PENDING, VERIFIED, REJECTED
  pendingChanges String? // JSON string of proposed changes for verified profiles

  user   User   @relation(fields: [userId], references: [id])
  userId String @unique
  
  // Relations
  products Product[]
  rfqResponses RfqResponse[]
  orders Order[]
  reviews Review[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model BuyerProfile {
  id           String @id @default(cuid())
  businessName String
  city         String?
  
  user   User   @relation(fields: [userId], references: [id])
  userId String @unique
  
  rfqs Rfq[]
  orders Order[]
  reviews Review[]
}

model Product {
  id          String @id @default(cuid())
  name        String
  description String
  price       Float?
  priceMin    Float?
  priceMax    Float?
  moq         Int?
  imageUrl    String?
  attributes  String? // JSON string: { "Material": "Steel", "Voltage": "220V" }
  customization String? // JSON string: { "logo": true, "packaging": true }
  leadTime    String? // JSON string: [{ "qty": "1-100", "days": 7 }]
  status      String   @default("PENDING") // PENDING, APPROVED, REJECTED
  
  factory   FactoryProfile @relation(fields: [factoryId], references: [id])
  factoryId String
}

model Rfq {
  id          String   @id @default(cuid())
  title       String
  description String
  quantity    Int
  status      String   @default("OPEN") // OPEN, CLOSED, AWARDED
  createdAt   DateTime @default(now())
  
  buyer   BuyerProfile @relation(fields: [buyerId], references: [id])
  buyerId String
  
  responses RfqResponse[]
  orders    Order[]
}

model RfqResponse {
  id        String   @id @default(cuid())
  price     Float
  notes     String?
  createdAt DateTime @default(now())
  status    String   @default("PENDING") // PENDING, REJECTED, AWARDED
  
  rfq   Rfq @relation(fields: [rfqId], references: [id])
  rfqId String
  
  factory   FactoryProfile @relation(fields: [factoryId], references: [id])
  factoryId String

  order Order?
}

model Order {
  id        String   @id @default(cuid())
  status    String   @default("PENDING") // PENDING, PROCESSING, SHIPPED, DELIVERED, CANCELLED, DISPUTED
  totalPrice Float
  
  paymentStatus String @default("UNPAID") // UNPAID, PAID, REFUNDED
  paymentMethod String? // CREDIT_CARD, MADA, TRANSFER
  paymentId     String? // Transaction ID
  
  buyer   BuyerProfile @relation(fields: [buyerId], references: [id])
  buyerId String
  
  factory   FactoryProfile @relation(fields: [factoryId], references: [id])
  factoryId String
  
  rfq   Rfq? @relation(fields: [rfqId], references: [id])
  rfqId String?
  
  quote   RfqResponse? @relation(fields: [quoteId], references: [id])
  quoteId String? @unique
  
  dispute Dispute?
  review  Review?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model SiteContent {
  id        String   @id @default(cuid())
  key       String   @unique // e.g., "homepage_hero"
  content   String   // JSON string
  updatedAt DateTime @updatedAt
}

model Dispute {
  id          String   @id @default(cuid())
  orderId     String   @unique
  reporterId  String
  reason      String
  description String
  status      String   @default("OPEN") // OPEN, RESOLVED, REJECTED
  adminNotes  String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  order    Order @relation(fields: [orderId], references: [id])
  reporter User  @relation(fields: [reporterId], references: [id])
}

model Review {
  id        String   @id @default(cuid())
  orderId   String   @unique
  buyerId   String
  factoryId String
  rating    Int      // 1-5
  comment   String?
  createdAt DateTime @default(now())

  order   Order          @relation(fields: [orderId], references: [id])
  buyer   BuyerProfile   @relation(fields: [buyerId], references: [id])
  factory FactoryProfile @relation(fields: [factoryId], references: [id])
}
