generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                     String          @id @default(cuid())
  email                  String          @unique
  password               String
  role                   String          @default("BUYER")
  createdAt              DateTime        @default(now())
  updatedAt              DateTime        @updatedAt
  isBanned               Boolean         @default(false)
  isVerified             Boolean         @default(false)
  verificationCode       String?
  buyerProfile           BuyerProfile?
  receivedConversations  Conversation[]  @relation("Receiver")
  initiatedConversations Conversation[]  @relation("Starter")
  filedDisputes          Dispute[]
  factoryProfile         FactoryProfile?
  messages               Message[]
  notifications          Notification[]
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  type      String
  title     String
  message   String
  link      String?
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])
}

model Conversation {
  id            String    @id @default(cuid())
  starterId     String
  receiverId    String
  lastMessageAt DateTime  @default(now())
  subject       String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  receiver      User      @relation("Receiver", fields: [receiverId], references: [id])
  starter       User      @relation("Starter", fields: [starterId], references: [id])
  messages      Message[]

  @@unique([starterId, receiverId])
}

model Message {
  id             String       @id @default(cuid())
  conversationId String
  senderId       String
  content        String
  attachmentUrl  String?
  attachmentType String?
  read           Boolean      @default(false)
  createdAt      DateTime     @default(now())
  conversation   Conversation @relation(fields: [conversationId], references: [id])
  sender         User         @relation(fields: [senderId], references: [id])
}

model FactoryProfile {
  id                 String        @id @default(cuid())
  businessName       String
  businessNameAr     String?
  crNumber           String?
  licenseNumber      String?
  city               String?
  industry           String?
  description        String?
  logoUrl            String?
  crDocumentUrl      String?
  licenseDocumentUrl String?
  taxNumber          String?
  taxDocumentUrl     String?
  sasoDocumentUrl    String?
  isVerified         Boolean       @default(false)
  verificationStatus String        @default("UNVERIFIED")
  pendingChanges     String?
  userId             String        @unique
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt
  user               User          @relation(fields: [userId], references: [id])
  orders             Order[]
  products           Product[]
  reviews            Review[]
  rfqResponses       RfqResponse[]
}

model BuyerProfile {
  id           String   @id @default(cuid())
  businessName String
  city         String?
  userId       String   @unique
  user         User     @relation(fields: [userId], references: [id])
  orders       Order[]
  reviews      Review[]
  rfqs         Rfq[]
}

model Product {
  id            String         @id @default(cuid())
  name          String
  description   String
  price         Float?
  priceMin      Float?
  priceMax      Float?
  moq           Int?
  imageUrl      String?
  attributes    String?
  customization String?
  leadTime      String?
  status        String         @default("PENDING")
  factoryId     String
  factory       FactoryProfile @relation(fields: [factoryId], references: [id])
}

model Rfq {
  id          String        @id @default(cuid())
  title       String
  description String
  quantity    Int
  status      String        @default("OPEN")
  createdAt   DateTime      @default(now())
  buyerId     String
  orders      Order[]
  buyer       BuyerProfile  @relation(fields: [buyerId], references: [id])
  responses   RfqResponse[]
}

model RfqResponse {
  id        String         @id @default(cuid())
  price     Float
  notes     String?
  createdAt DateTime       @default(now())
  status    String         @default("PENDING")
  rfqId     String
  factoryId String
  order     Order?
  factory   FactoryProfile @relation(fields: [factoryId], references: [id])
  rfq       Rfq            @relation(fields: [rfqId], references: [id])
}

model Order {
  id            String         @id @default(cuid())
  status        String         @default("PENDING")
  totalPrice    Float
  paymentStatus String         @default("UNPAID")
  paymentMethod String?
  paymentId     String?
  buyerId       String
  factoryId     String
  rfqId         String?
  quoteId       String?        @unique
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  dispute       Dispute?
  buyer         BuyerProfile   @relation(fields: [buyerId], references: [id])
  factory       FactoryProfile @relation(fields: [factoryId], references: [id])
  quote         RfqResponse?   @relation(fields: [quoteId], references: [id])
  rfq           Rfq?           @relation(fields: [rfqId], references: [id])
  review        Review?
}

model SiteContent {
  id        String   @id @default(cuid())
  key       String   @unique
  content   String
  updatedAt DateTime @updatedAt
}

model Dispute {
  id          String   @id @default(cuid())
  orderId     String   @unique
  reporterId  String
  reason      String
  description String
  status      String   @default("OPEN")
  adminNotes  String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  order       Order    @relation(fields: [orderId], references: [id])
  reporter    User     @relation(fields: [reporterId], references: [id])
}

model Review {
  id        String         @id @default(cuid())
  orderId   String         @unique
  buyerId   String
  factoryId String
  rating    Int
  comment   String?
  createdAt DateTime       @default(now())
  buyer     BuyerProfile   @relation(fields: [buyerId], references: [id])
  factory   FactoryProfile @relation(fields: [factoryId], references: [id])
  order     Order          @relation(fields: [orderId], references: [id])
}
